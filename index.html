<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "htt`://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>生日快乐呀!(●ˇ∀ˇ●)</title>     
    <link type="text/css" rel="stylesheet" href="./css/default.css">
    <script type="text/javascript" src="./css/jquery.min.js"></script>
    <script type="text/javascript" src="./css/jscex.min.js"></script>
    <script type="text/javascript" src="./css/jscex-parser.js"></script>
    <script type="text/javascript" src="./css/jscex-jit.js"></script>
    <script type="text/javascript" src="./css/jscex-builderbase.min.js"></script>
    <script type="text/javascript" src="./css/jscex-async.min.js"></script>
    <script type="text/javascript" src="./css/jscex-async-powerpack.min.js"></script>
    <script type="text/javascript" src="./css/functions.js" charset="utf-8"></script>
    <script type="text/javascript" src="./css/love.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery-3.2.0.js"></script>
	
</head>
<body>
    <audio autoplay="autopaly">  <!--背景音乐 --> 
          <source src="music/love.mp3" type="audio/mp3" />
    </audio>
    <div id="main">
        <div id="wrap">
            <div id="text">
                <div id="code">
                <font color="#FF0000">    
				<span class="say"><h3>愿你眼角带笑，</h3></span><br><br>
				<span class="say"><B>月色不染眉梢。</B></span><br> <br>    
				<span class="say"><B>愿你眉眼如初，</B></span><br><br>
				<span class="say"><B>岁月如故。</B></span><br><br>
				<span class="say"><B>愿你温柔不变，</B></span><br><br>
				<span class="say"><B>情深不伤。</B></span><br><br>
				<span class="say"><B>一生久安，</B></span><br><br>
				<span class="say"><B>岁月无恙！</B></span><br><br>
				<span class="say"><B>......</B></span><br>
				<span class="say"><h2><I>Happy Birthday to Mrs.Xiao!</I></h2></span><br>
				</font>
				</div>
            </div>
			<canvas id="canvas" width="1100" height="680"></canvas> <!--画布 制作动画 -->
        </div>       
    </div>
	
    <script>
    (function(){
        var canvas = $('#canvas');
		
        if (!canvas[0].getContext) { <!--提示错误信息-->
            $("#error").show();
            return false;        }

        var width = canvas.width();  <!--1100 -->
        var height = canvas.height();<!--680 -->  
		canvas.attr("width", width);
        canvas.attr("height", height);
        var opts = {
			<!--小红心-->
            seed: {
                x: width / 2 - 20,
                color: "rgb(190, 26, 37)",
                scale: 2
				},
			<!--树-->
            branch: [
                [535, 680, 570, 250, 500, 200, 30, 100, [
                    [540, 500, 455, 417, 340, 400, 13, 100, [
                        [450, 435, 434, 430, 394, 395, 2, 40]
                    ]],
                    [550, 445, 600, 356, 680, 345, 12, 100, [
                        [578, 400, 648, 409, 661, 426, 3, 80]
                    ]],
                    [539, 281, 537, 248, 534, 217, 3, 40],
                    [546, 397, 413, 247, 328, 244, 9, 80, [
                        [427, 286, 383, 253, 371, 205, 2, 40],
                        [498, 345, 435, 315, 395, 330, 4, 60]
                    ]],
                    [546, 357, 608, 252, 678, 221, 6, 100, [
                        [590, 293, 646, 277, 648, 271, 2, 80]
                    ]]
                ]] 
				],
			<!--花-->
            bloom: {
                num: 520,
                width: 1080,
                height: 650,
				},
			<!--根-->
            footer: {
                width: 1000,
                height: 5,
                speed: 10,
				}
        }

        var tree = new Tree(canvas[0], width, height, opts);
        var seed = tree.seed;
        var foot = tree.footer;
        var hold = 1;

        canvas.click(function(e) {
            var offset = canvas.offset(), x, y;
            x = e.pageX - offset.left;
            y = e.pageY - offset.top;
            if (seed.hover(x, y)) {
                hold = 0; 
                canvas.unbind("click");
                canvas.unbind("mousemove");
                canvas.removeClass('hand');
            }
        }).mousemove(function(e){
            var offset = canvas.offset(), x, y;
            x = e.pageX - offset.left;
            y = e.pageY - offset.top;
            canvas.toggleClass('hand', seed.hover(x, y));
        });

        var seedAnimate = eval(Jscex.compile("async", function () {
            seed.draw();
            while (hold) {
                $await(Jscex.Async.sleep(10));
            }
            while (seed.canScale()) {
                seed.scale(0.95);
                $await(Jscex.Async.sleep(10));
            }
            while (seed.canMove()) {
                seed.move(0, 2);
                foot.draw();
                $await(Jscex.Async.sleep(10));
            }
        }));

        var growAnimate = eval(Jscex.compile("async", function () {
            do {
              tree.grow();
                $await(Jscex.Async.sleep(10));
            } while (tree.canGrow());
        }));

        var flowAnimate = eval(Jscex.compile("async", function () {
            do {
              tree.flower(2);
                $await(Jscex.Async.sleep(10));
            } while (tree.canFlower());
        }));

        var moveAnimate = eval(Jscex.compile("async", function () {
            tree.snapshot("p1", 240, 0, 610, 680);
            while (tree.move("p1", 500, 0)) {
                foot.draw();
                $await(Jscex.Async.sleep(10));
            }
            foot.draw();
            tree.snapshot("p2", 500, 0, 610, 680);

            canvas.parent().css("background", "url(" + tree.toDataURL('image/png') + ")");
            canvas.css("background", "#ffe");
            $await(Jscex.Async.sleep(300));
            canvas.css("background", "none");
        }));

        var jumpAnimate = eval(Jscex.compile("async", function () {
            var ctx = tree.ctx;
            while (true) {
                tree.ctx.clearRect(0, 0, width, height);
                tree.jump();
                foot.draw();
                $await(Jscex.Async.sleep(25));
            }
        }));

        var textAnimate = eval(Jscex.compile("async", function () {
		/*
        var together = new Date();
        together.setFullYear(2009,10,23 );      //时间年月日
        together.setHours(16);            //小时  
        together.setMinutes(53);          //分钟
        together.setSeconds(0);         //秒前一位
        together.setMilliseconds(2);        //秒第二位
		*/
        $("#code").show().typewriter();
            $("#clock-box").fadeIn(500);
            while (true) {
                timeElapse(together);
                $await(Jscex.Async.sleep(1000));
            }
        }));

        var runAsync = eval(Jscex.compile("async", function () {
            $await(seedAnimate());
            $await(growAnimate());
            $await(flowAnimate());
            $await(moveAnimate());

            textAnimate().start();

            $await(jumpAnimate());
        }));

        runAsync().start();
    })();
    </script>
	<script type="text/javascript">
		$(function(){
			var Fireworks = function(){
			var self = this;
			var rand = function(rMi, rMa){
				return ~~((Math.random()*(rMa-rMi+1))+rMi);
			}
			var hitTest = function(x1, y1, w1, h1, x2, y2, w2, h2){
				return !(x1 + w1 < x2 || x2 + w2 < x1 || y1 + h1 < y2 || y2 + h2 < y1);
			};
			window.requestAnimFrame=function(){
				return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){
				window.setTimeout(a,1E3/60)
				}
			}();
	
		self.init = function(){ 
			self.canvas = document.createElement('canvas');             
			self.canvas.width = self.cw = 1100;
			self.canvas.height = self.ch = 1500;         
			self.particles = [];    
			self.partCount = 150;
			self.fireworks = [];    
			self.mx = self.cw/2;
			self.my = self.ch/2;
			self.currentHue = 30;
			self.partSpeed = 3;
			self.partSpeedVariance = 10;
			self.partWind = 50;
			self.partFriction = 5;
			self.partGravity = 1;
			self.hueMin = 0;
			self.hueMax = 360;
			self.fworkSpeed = 8;
			self.fworkAccel = 10;
			self.hueVariance = 30;
			self.flickerDensity = 25;
			self.showShockwave = true;
			self.showTarget = false;
			self.clearAlpha = 10;
	
			$(document.body).append(self.canvas);
				self.ctx = self.canvas.getContext('2d');
				self.ctx.lineCap = 'round';
				self.ctx.lineJoin = 'round';
				self.lineWidth = 1;
				self.bindEvents();          
				self.canvasLoop();
	
			self.canvas.onselectstart = function(){
				return false;
				};
		};      
	
		self.createParticles = function(x,y, hue){
			var countdown = self.partCount;
			while(countdown--){
				var newParticle = {
					x: x,
					y: y,
					coordLast: [
						{x: x, y: y},
						{x: x, y: y},
						{x: x, y: y}
					],
					angle: rand(0, 360),
					speed: rand(((self.partSpeed - self.partSpeedVariance) <= 0) ? 1 : self.partSpeed - self.partSpeedVariance, (self.partSpeed + self.partSpeedVariance)),
					friction: 1 - self.partFriction/100,
					gravity: self.partGravity/2,
					hue: rand(hue-self.hueVariance, hue+self.hueVariance),
					brightness: rand(50, 80),
					alpha: rand(40,100)/100,
					decay: rand(10, 50)/1000,
					wind: (rand(0, self.partWind) - (self.partWind/2))/25,
					lineWidth: self.lineWidth
				};              
				self.particles.push(newParticle);
			}
		};
	
	
		self.updateParticles = function(){
			var i = self.particles.length;
			while(i--){
				var p = self.particles[i];
				var radians = p.angle * Math.PI / 180;
				var vx = Math.cos(radians) * p.speed;
				var vy = Math.sin(radians) * p.speed;
				p.speed *= p.friction;
								
				p.coordLast[2].x = p.coordLast[1].x;
				p.coordLast[2].y = p.coordLast[1].y;
				p.coordLast[1].x = p.coordLast[0].x;
				p.coordLast[1].y = p.coordLast[0].y;
				p.coordLast[0].x = p.x;
				p.coordLast[0].y = p.y;
	
				p.x += vx;
				p.y += vy;
				p.y += p.gravity;
	
				p.angle += p.wind;              
				p.alpha -= p.decay;
	
				if(!hitTest(0,0,self.cw,self.ch,p.x-p.radius, p.y-p.radius, p.radius*2, p.radius*2) || p.alpha < .05){                  
					self.particles.splice(i, 1);    
				}
			};
		};
	
		self.drawParticles = function(){
			var i = self.particles.length;
			while(i--){
				var p = self.particles[i];                          
	
				var coordRand = (rand(1,3)-1);
				self.ctx.beginPath();                               
				self.ctx.moveTo(Math.round(p.coordLast[coordRand].x), Math.round(p.coordLast[coordRand].y));
				self.ctx.lineTo(Math.round(p.x), Math.round(p.y));
				self.ctx.closePath();               
				self.ctx.strokeStyle = 'hsla('+p.hue+', 100%, '+p.brightness+'%, '+p.alpha+')';
				self.ctx.stroke();              
	
			if(self.flickerDensity > 0){
				var inverseDensity = 50 - self.flickerDensity;                  
				if(rand(0, inverseDensity) === inverseDensity){
					self.ctx.beginPath();
					self.ctx.arc(Math.round(p.x), Math.round(p.y), rand(p.lineWidth,p.lineWidth+3)/2, 0, Math.PI*2, false)
					self.ctx.closePath();
					var randAlpha = rand(50,100)/100;
					self.ctx.fillStyle = 'hsla('+p.hue+', 100%, '+p.brightness+'%, '+randAlpha+')';
					self.ctx.fill();
					}   
				}
			};
		};
	
	
		self.createFireworks = function(startX, startY, targetX, targetY){
			var newFirework = {
				x: startX,
				y: startY,
				startX: startX,
				startY: startY,
				hitX: false,
				hitY: false,
				coordLast: [
					{x: startX, y: startY},
					{x: startX, y: startY},
					{x: startX, y: startY}
				],
				targetX: targetX,
				targetY: targetY,
				speed: self.fworkSpeed,
				angle: Math.atan2(targetY - startY, targetX - startX),
				shockwaveAngle: Math.atan2(targetY - startY, targetX - startX)+(90*(Math.PI/180)),
				acceleration: self.fworkAccel/100,
				hue: self.currentHue,
				brightness: rand(50, 80),
				alpha: rand(50,100)/100,
				lineWidth: self.lineWidth
			};          
			self.fireworks.push(newFirework);
		};
	
	
		self.updateFireworks = function(){
			var i = self.fireworks.length;
			while(i--){
				var f = self.fireworks[i];
				self.ctx.lineWidth = f.lineWidth;
				vx = Math.cos(f.angle) * f.speed,
				vy = Math.sin(f.angle) * f.speed;
				f.speed *= 1 + f.acceleration;              
				f.coordLast[2].x = f.coordLast[1].x;
				f.coordLast[2].y = f.coordLast[1].y;
				f.coordLast[1].x = f.coordLast[0].x;
				f.coordLast[1].y = f.coordLast[0].y;
				f.coordLast[0].x = f.x;
				f.coordLast[0].y = f.y;
				if(f.startX >= f.targetX){
					if(f.x + vx <= f.targetX){
						f.x = f.targetX;
						f.hitX = true;
					} else {
						f.x += vx;
					}
				} else {
					if(f.x + vx >= f.targetX){
						f.x = f.targetX;
						f.hitX = true;
					} else {
						f.x += vx;
					}
				}
	
				if(f.startY >= f.targetY){
					if(f.y + vy <= f.targetY){
						f.y = f.targetY;
						f.hitY = true;
					} else {
						f.y += vy;
					}
				} else {
					if(f.y + vy >= f.targetY){
						f.y = f.targetY;
						f.hitY = true;
					} else {
						f.y += vy;
					}
				}               
				if(f.hitX && f.hitY){
					self.createParticles(f.targetX, f.targetY, f.hue);
					self.fireworks.splice(i, 1);
					
				}
			};
		};
	
		self.drawFireworks = function(){
			var i = self.fireworks.length;
			self.ctx.globalCompositeOperation = 'lighter';
			while(i--){
				var f = self.fireworks[i];      
				self.ctx.lineWidth = f.lineWidth;
	
				var coordRand = (rand(1,3)-1);                  
				self.ctx.beginPath();                           
				self.ctx.moveTo(Math.round(f.coordLast[coordRand].x), Math.round(f.coordLast[coordRand].y));
				self.ctx.lineTo(Math.round(f.x), Math.round(f.y));
				self.ctx.closePath();
				self.ctx.strokeStyle = 'hsla('+f.hue+', 100%, '+f.brightness+'%, '+f.alpha+')';
				self.ctx.stroke();  
	
				if(self.showTarget){
					self.ctx.save();
					self.ctx.beginPath();
					self.ctx.arc(Math.round(f.targetX), Math.round(f.targetY), rand(1,8), 0, Math.PI*2, false)
					self.ctx.closePath();
					self.ctx.lineWidth = 1;
					self.ctx.stroke();
					self.ctx.restore();
				}
					
				if(self.showShockwave){
					self.ctx.save();
					self.ctx.translate(Math.round(f.x), Math.round(f.y));
					self.ctx.rotate(f.shockwaveAngle);
					self.ctx.beginPath();
					self.ctx.arc(0, 0, 1*(f.speed/5), 0, Math.PI, true);
					self.ctx.strokeStyle = 'hsla('+f.hue+', 100%, '+f.brightness+'%, '+rand(25, 60)/100+')';
					self.ctx.lineWidth = f.lineWidth;
					self.ctx.stroke();
					self.ctx.restore();
				}
			};
		};
	
		self.bindEvents = function(){
			$(window).on('resize', function(){          
			clearTimeout(self.timeout);
			self.timeout = setTimeout(function() {
				self.canvas.width = self.cw = $(window).innerWidth();
				self.canvas.height = self.ch = $(window).innerHeight();
				self.ctx.lineCap = 'round';
				self.ctx.lineJoin = 'round';
				},1);
			});
	
			window.onload=function(){
				 tttt()
			}
			var tttt = setInterval(function(){
				 var e={'pageX':Math.random()*1900,'pageY':Math.random()*900}
				self.mx = e.pageX - self.canvas.offsetLeft;
				self.my = e.pageY - self.canvas.offsetTop;
				self.currentHue = rand(self.hueMin, self.hueMax);
				self.createFireworks(self.cw/2, self.ch, self.mx, self.my); 
			},50)      
		}
	
		self.clear = function(){
			self.particles = [];
			self.fireworks = [];
			self.ctx.clearRect(0, 0, self.cw, self.ch);
			};
	
	
		self.canvasLoop = function(){
			requestAnimFrame(self.canvasLoop, self.canvas);         
			self.ctx.globalCompositeOperation = 'destination-out';
			self.ctx.fillStyle = 'rgba(0,0,0,'+self.clearAlpha/100+')';
			self.ctx.fillRect(0,0,self.cw,self.ch);
			self.updateFireworks();
			self.updateParticles();
			self.drawFireworks();           
			self.drawParticles();
			};
	
		self.init();        
		}
		var fworks = new Fireworks();
		});
		</script>
    
</body>
</html>
